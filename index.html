<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Murders - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Poppins, sans-serif; background: #f0f4f8; color: #333; display: flex; min-height: 100vh; }
    
    .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar h2 { margin-bottom: 30px; }
    .clan-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; background: #34495e; color: white; cursor: pointer; border-radius: 4px; font-family: Poppins, sans-serif; font-weight: 600; }
    .clan-btn.active { background: #e74c3c; }
    .clan-btn:hover { background: #2980b9; }
    .sidebar hr { margin: 20px 0; border: none; border-top: 1px solid #555; }
    .tab-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; background: #34495e; color: white; cursor: pointer; border-radius: 4px; font-family: Poppins, sans-serif; text-align: left; }
    .tab-btn.active { background: #3498db; font-weight: 600; }
    .tab-btn:hover { background: #2980b9; }
    
    .main { margin-left: 250px; flex: 1; padding: 20px; overflow-y: auto; }
    .header { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header h1 { font-size: 24px; color: #2c3e50; }
    
    .card { background: white; padding: 20px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card h3 { color: #2c3e50; margin-bottom: 8px; font-size: 16px; }
    .card p { font-size: 12px; color: #7f8c8d; margin-bottom: 15px; }
    
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: Poppins, sans-serif; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-secondary:hover { background: #7f8c8d; }
    
    .input-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; align-items: flex-end; }
    .input, select, textarea { padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: Poppins, sans-serif; font-size: 12px; }
    .input { flex: 1; min-width: 150px; }
    select { flex: 0.5; min-width: 120px; }
    textarea { width: 100%; min-height: 60px; resize: vertical; }
    
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    table thead { background: #ecf0f1; position: sticky; top: 0; }
    table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #bdc3c7; }
    table th { font-weight: 600; }
    table tbody tr:hover { background: #f8f9fa; }
    
    .modal { display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
    .modal.active { display: flex !important; align-items: flex-start; justify-content: center; padding-top: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: 4px; width: 90%; max-width: 500px; margin-bottom: 20px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 18px; color: #2c3e50; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; margin-bottom: 4px; font-weight: 600; color: #2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: Poppins, sans-serif; font-size: 12px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    
    .tab { display: none !important; }
    .tab.active { display: block !important; }
    
    .empty { text-align: center; color: #7f8c8d; padding: 20px; }
    .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    
    @media (max-width: 768px) {
      .sidebar { width: 100%; height: auto; position: relative; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>‚öîÔ∏è Murders</h2>
    <button class="clan-btn active" onclick="setClan(1)" data-clan="1">Clan 1</button>
    <button class="clan-btn" onclick="setClan(2)" data-clan="2">Clan 2</button>
    <hr>
    <button class="tab-btn active" onclick="switchTab('members')" data-tab="members">üë• Membros</button>
    <button class="tab-btn" onclick="switchTab('events')" data-tab="events">üìä Presen√ßa</button>
    <button class="tab-btn" onclick="switchTab('deliveries')" data-tab="deliveries">üì¶ Entregas</button>
    <button class="tab-btn" onclick="switchTab('repo')" data-tab="repo">üìÇ Reposit√≥rio</button>
    <button class="tab-btn" onclick="switchTab('reports')" data-tab="reports">üìà Relat√≥rios</button>
  </div>

  <div class="main">
    <div class="header">
      <div>
        <h1 id="pageTitle">üë• Membros</h1>
        <p style="color: #7f8c8d; font-size: 13px;">Cl√£ <span id="clanDisplay">1</span></p>
      </div>
      <button class="btn btn-secondary" onclick="toggleTheme()">üåô Tema</button>
    </div>

    <div class="card" id="global-actions">
      <h3>Importar / Exportar dados</h3>
      <p>Use estes bot√µes para salvar ou carregar todos os dados do painel.</p>
      <div class="btn-row">
        <button class="btn btn-secondary" type="button" onclick="clickImportJSON()">üì• Importar JSON</button>
        <button class="btn btn-primary" type="button" onclick="exportJSON()">üì§ Exportar JSON</button>
        <button class="btn btn-secondary" type="button" onclick="exportPDF()">üì§ Exportar PDF</button>
      </div>
      <input type="file" id="json-file-input" accept=".json,application/json" style="display:none">
    </div>

    <div id="msgContainer"></div>

    <div class="card">
      <h3>Webhooks do Discord - Cl√£ <span id="webhookClanDisplay">1</span></h3>
      <p>Configure webhooks diferentes para cada cl√£ e canal.</p>
      <div style="margin-bottom: 15px;">
        <label style="font-size: 12px; font-weight: 600; color: #2c3e50; display: block; margin-bottom: 4px;">Webhook - Membros</label>
        <div class="input-row">
          <input id="webhookUrl-members" class="input" placeholder="URL do webhook para membros..." style="flex: 1;">
          <button class="btn btn-primary" onclick="saveWebhook('members')">‚úÖ Salvar</button>
        </div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="font-size: 12px; font-weight: 600; color: #2c3e50; display: block; margin-bottom: 4px;">Webhook - Presen√ßa</label>
        <div class="input-row">
          <input id="webhookUrl-events" class="input" placeholder="URL do webhook para presen√ßa..." style="flex: 1;">
          <button class="btn btn-primary" onclick="saveWebhook('events')">‚úÖ Salvar</button>
        </div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="font-size: 12px; font-weight: 600; color: #2c3e50; display: block; margin-bottom: 4px;">Webhook - Entregas</label>
        <div class="input-row">
          <input id="webhookUrl-deliveries" class="input" placeholder="URL do webhook para entregas..." style="flex: 1;">
          <button class="btn btn-primary" onclick="saveWebhook('deliveries')">‚úÖ Salvar</button>
        </div>
      </div>
      
      <div>
        <label style="font-size: 12px; font-weight: 600; color: #2c3e50; display: block; margin-bottom: 4px;">Webhook - Reposit√≥rio</label>
        <div class="input-row">
          <input id="webhookUrl-repo" class="input" placeholder="URL do webhook para reposit√≥rio..." style="flex: 1;">
          <button class="btn btn-primary" onclick="saveWebhook('repo')">‚úÖ Salvar</button>
        </div>
      </div>
    </div>

    <div class="tab active" id="tab-members">
      <div class="card">
        <h3>Membros do cl√£</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openMemberModal()">‚ûï Novo membro</button>
          <button class="btn btn-danger" onclick="clearAllMembers()">üóëÔ∏è Apagar todos</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('membros')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <input id="searchMembers" class="input" placeholder="üîç Buscar nick..." oninput="renderMembers()" style="flex: 1;">
          <select id="filterClass" onchange="renderMembers()">
            <option value="">Todas as classes</option>
            <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Nick</th><th>Level</th><th>Power</th><th>Classe</th><th>Data</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="members-body"><tr><td colspan="6" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab" id="tab-events">
      <div class="card">
        <h3>Presen√ßa em eventos</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openEventModal()">‚ûï Novo evento</button>
          <button class="btn btn-danger" onclick="clearAllEvents()">üóëÔ∏è Apagar tudo</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('presencas')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <select id="filterEvent" onchange="renderEvents()">
            <option value="">Todos eventos</option><option>Boss do cl√£</option><option>Copa Ymir</option><option>Guerra da coroa</option><option>Ilha de Sindri</option><option>Interserver</option>
          </select>
          <select id="filterStatus" onchange="renderEvents()">
            <option value="">Todos status</option><option>Presente</option><option>Faltou</option><option>Justificou</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Data</th><th>Nick</th><th>Evento</th><th>Status</th><th>Justificativa</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="events-body"><tr><td colspan="6" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab" id="tab-deliveries">
      <div class="card">
        <h3>Entregas do cl√£</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openDeliveryModal()">‚ûï Registrar entrega</button>
          <button class="btn btn-secondary" onclick="showMonthlyReport()">üìã Relat√≥rio mensal</button>
          <button class="btn btn-danger" onclick="clearAllDeliveries()">üóëÔ∏è Apagar tudo</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('entregas')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <input id="searchDeliveriesNick" class="input" placeholder="üîç Buscar nick..." oninput="renderDeliveries()" style="flex: 1;">
          <select id="filterDeliveriesClass" onchange="renderDeliveries()">
            <option value="">Todas as classes</option><option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Data</th><th>Nick</th><th>Classe</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="deliveries-body"><tr><td colspan="5" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
        <div class="card" id="monthly-report-card" style="margin-top:14px; display:none;">
          <h3>Relat√≥rio mensal</h3>
          <div class="input-row">
            <input type="month" class="input" id="reportMonth" onchange="renderMonthlyReport()" />
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Nick</th><th>Resumo</th></tr></thead>
              <tbody id="monthly-report-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab" id="tab-repo">
      <div class="card">
        <h3>Reposit√≥rio</h3>
        <div class="card" style="margin-bottom:10px;">
          <h3>Novo item</h3>
          <div class="form-group">
            <label>Item</label>
            <input id="repoItem" class="input" placeholder="Nome do item" />
          </div>
          <div class="form-group">
            <label>Tipo</label>
            <input id="repoType" class="input" placeholder="Tipo" />
          </div>
          <div class="form-group">
            <label>Boss</label>
            <input id="repoBoss" class="input" placeholder="Boss" />
          </div>
          <div class="form-group">
            <label>Quantidade</label>
            <input id="repoQuantity" class="input" type="number" placeholder="Qtd" />
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="btn btn-primary" onclick="addRepoItem()">Salvar</button>
            <button class="btn btn-danger" onclick="clearRepo()">Limpar</button>
          </div>
        </div>
        <input id="searchRepoItem" class="input" placeholder="üîç Buscar..." oninput="renderRepo()" style="margin-bottom: 15px;">
        <div class="table-container">
          <table>
            <thead><tr><th>Item</th><th>Tipo</th><th>Boss</th><th>Qtd</th><th>A√ß√µes</th></tr></thead>
            <tbody id="repoTableBody"></tbody>
          </table>
        </div>
        <div class="card" style="margin-top: 15px;">
          <button class="btn btn-secondary" onclick="sendToDiscord('repo')">üí¨ Enviar para Discord</button>
        </div>
      </div>
    </div>

    <div class="tab" id="tab-reports">
      <div class="card">
        <h3>Relat√≥rios</h3>
        <p>Resumo por semana</p>
      </div>
    </div>
  </div>

  <div class="modal" id="member-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Membro</h2>
        <button class="close-btn" onclick="closeModal('member-modal')">‚úï</button>
      </div>
      <input type="hidden" id="member-index" />
      <div class="form-group">
        <label>Nick</label>
        <input id="member-nick" class="input" />
      </div>
      <div class="form-group">
        <label>Level</label>
        <input id="member-level" class="input" type="number" />
      </div>
      <div class="form-group">
        <label>Power</label>
        <input id="member-power" class="input" type="number" />
      </div>
      <div class="form-group">
        <label>Classe</label>
        <select id="member-class" class="input">
          <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
        </select>
      </div>
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="member-date" class="input" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('member-modal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveMember()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="event-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Evento</h2>
        <button class="close-btn" onclick="closeModal('event-modal')">‚úï</button>
      </div>
      <input type="hidden" id="event-index" />
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="event-date" class="input" />
      </div>
      <div class="form-group">
        <label>Evento</label>
        <select id="event-name" class="input">
          <option>Boss do cl√£</option><option>Copa Ymir</option><option>Guerra da coroa</option><option>Ilha de Sindri</option><option>Interserver</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nick</label>
        <select id="event-nick" class="input"></select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="event-status" class="input">
          <option>Presente</option><option>Faltou</option><option>Justificou</option>
        </select>
      </div>
      <div class="form-group">
        <label>Justificativa</label>
        <input id="event-just" class="input" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('event-modal')">Fechar</button>
        <button class="btn btn-primary" onclick="saveEvent()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="delivery-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Entrega</h2>
        <button class="close-btn" onclick="closeModal('delivery-modal')">‚úï</button>
      </div>
      <input type="hidden" id="delivery-index" />
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="delivery-date" class="input" />
      </div>
      <div class="form-group">
        <label>Nick</label>
        <input id="delivery-nick" class="input" />
      </div>
      <div class="form-group">
        <label>Classe</label>
        <select id="delivery-class" class="input">
          <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
        </select>
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input id="delivery-desc" class="input" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('delivery-modal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveDelivery()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'murders_painel_v9';
    let state = {
      clan: 1,
      webhooks: { 
        1: { members: '', events: '', deliveries: '', repo: '' },
        2: { members: '', events: '', deliveries: '', repo: '' }
      },
      members: { 1: [], 2: [] },
      events: { 1: [], 2: [] },
      deliveries: { 1: [], 2: [] },
      repoItems: { 1: [], 2: [] }
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
          console.log('‚úÖ Estado carregado');
        }
      } catch (e) {
        console.error('Erro ao carregar:', e);
      }
      
      if (state.webhooks && state.webhooks[state.clan]) {
        document.getElementById('webhookUrl-members').value = state.webhooks[state.clan].members || '';
        document.getElementById('webhookUrl-events').value = state.webhooks[state.clan].events || '';
        document.getElementById('webhookUrl-deliveries').value = state.webhooks[state.clan].deliveries || '';
        document.getElementById('webhookUrl-repo').value = state.webhooks[state.clan].repo || '';
      }
      
      renderAll();
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      showMessage('‚úÖ Dados salvos!', 'success');
    }

    function showMessage(msg, type = 'success') {
      const container = document.getElementById('msgContainer');
      container.innerHTML = `<div class="${type}">${msg}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 3000);
    }

    function toISOFromBR(brDate) {
      if (!brDate) return '';
      const parts = brDate.split('/');
      if (parts.length !== 3) return '';
      const [d, m, y] = parts;
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function toBRFromISO(isoDate) {
      if (!isoDate) return '';
      const [y, m, d] = isoDate.split('-');
      if (!y || !m || !d) return '';
      return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    }

    function todayBR() {
      const now = new Date();
      return `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
    }

    function setClan(clan) {
      state.clan = clan;
      document.querySelectorAll('.clan-btn').forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.clan) === clan);
      });
      document.getElementById('clanDisplay').textContent = clan;
      document.getElementById('webhookClanDisplay').textContent = clan;
      
      if (state.webhooks && state.webhooks[clan]) {
        document.getElementById('webhookUrl-members').value = state.webhooks[clan].members || '';
        document.getElementById('webhookUrl-events').value = state.webhooks[clan].events || '';
        document.getElementById('webhookUrl-deliveries').value = state.webhooks[clan].deliveries || '';
        document.getElementById('webhookUrl-repo').value = state.webhooks[clan].repo || '';
      }
      
      renderAll();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tab').forEach(sec => {
        sec.classList.toggle('active', sec.id === 'tab-' + tab);
      });
    }

    function toggleTheme() {
      document.body.style.background = document.body.style.background === 'rgb(30, 30, 30)' ? '#f0f4f8' : '#1e1e1e';
      document.body.style.color = document.body.style.color === 'rgb(255, 255, 255)' ? '#333' : '#fff';
    }

    function saveWebhook(type) {
      const value = document.getElementById('webhookUrl-' + type).value.trim();
      if (!state.webhooks[state.clan]) state.webhooks[state.clan] = {};
      state.webhooks[state.clan][type] = value;
      saveState();
    }

    function sendToDiscord(tipo) {
      let webhookUrl = '';
      if (!state.webhooks || !state.webhooks[state.clan]) {
        showMessage('‚ö†Ô∏è Configure o webhook', 'error');
        return;
      }
      
      if (tipo === 'membros') webhookUrl = state.webhooks[state.clan].members || '';
      else if (tipo === 'presencas') webhookUrl = state.webhooks[state.clan].events || '';
      else if (tipo === 'entregas') webhookUrl = state.webhooks[state.clan].deliveries || '';
      else if (tipo === 'repo') webhookUrl = state.webhooks[state.clan].repo || '';
      
      if (!webhookUrl) {
        showMessage('‚ö†Ô∏è Configure o webhook para ' + tipo, 'error');
        return;
      }
      showMessage('üì§ Enviando...', 'success');
    }

    function clickImportJSON() {
      document.getElementById('json-file-input').onchange = handleJSONFile;
      document.getElementById('json-file-input').click();
    }

    function handleJSONFile(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            state.members[state.clan] = imported;
            saveState();
            renderAll();
            showMessage(`‚úÖ ${imported.length} membros importados!`, 'success');
          } else if (imported.repoItems) {
            state.repoItems[state.clan] = imported.repoItems;
            saveState();
            renderAll();
            showMessage(`‚úÖ ${imported.repoItems.length} itens importados!`, 'success');
          } else if (imported.members && imported.events && imported.deliveries && imported.repoItems) {
            state = imported;
            saveState();
            renderAll();
            showMessage('‚úÖ Dados importados!', 'success');
          } else {
            showMessage('‚ùå Formato inv√°lido!', 'error');
          }
        } catch (err) {
          showMessage('‚ùå Erro: ' + err.message, 'error');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function exportJSON() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `murders-clan${state.clan}-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showMessage('‚úÖ Exportado!', 'success');
    }

    function exportPDF() {
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const w = window.open('', '_blank');
        w.document.write(`<html><body>${activeTab.innerHTML}</body></html>`);
        w.print();
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function openMemberModal(index = null) {
      document.getElementById('member-index').value = index !== null ? index : '';
      if (index !== null && index !== '') {
        const m = state.members[state.clan][index];
        document.getElementById('member-nick').value = m.nick;
        document.getElementById('member-level').value = m.level || '';
        document.getElementById('member-power').value = m.power || '';
        document.getElementById('member-class').value = m.classe || 'Arqueira';
        document.getElementById('member-date').value = toBRFromISO(m.data) || todayBR();
      } else {
        document.getElementById('member-nick').value = '';
        document.getElementById('member-level').value = '';
        document.getElementById('member-power').value = '';
        document.getElementById('member-class').value = 'Arqueira';
        document.getElementById('member-date').value = todayBR();
      }
      openModal('member-modal');
    }

    function saveMember() {
      const idx = document.getElementById('member-index').value;
      const nick = document.getElementById('member-nick').value.trim();
      if (!nick) { showMessage('‚ùå Nick obrigat√≥rio', 'error'); return; }
      const record = {
        nick,
        level: document.getElementById('member-level').value.trim(),
        power: document.getElementById('member-power').value.trim(),
        classe: document.getElementById('member-class').value,
        data: toISOFromBR(document.getElementById('member-date').value)
      };
      if (idx !== '') state.members[state.clan][parseInt(idx)] = record;
      else state.members[state.clan].push(record);
      saveState();
      closeModal('member-modal');
      renderMembers();
      fillEventNickOptions();
    }

    function deleteMember(index) {
      if (confirm('Excluir?')) {
        state.members[state.clan].splice(index, 1);
        saveState();
        renderMembers();
        fillEventNickOptions();
        showMessage('‚úÖ Exclu√≠do!', 'success');
      }
    }

    function renderMembers() {
      const body = document.getElementById('members-body');
      let list = [...(state.members[state.clan] || [])];
      const search = (document.getElementById('searchMembers')?.value || '').toLowerCase();
      const filterClass = document.getElementById('filterClass')?.value || '';
      if (search) list = list.filter(m => (m.nick || '').toLowerCase().includes(search));
      if (filterClass) list = list.filter(m => m.classe === filterClass);
      list.sort((a, b) => (a.nick || '').localeCompare(b.nick || '', 'pt-BR'));
      body.innerHTML = list.map((m, i) => `
        <tr>
          <td>${m.nick}</td><td>${m.level}</td><td>${m.power}</td><td>${m.classe}</td><td>${toBRFromISO(m.data)}</td>
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openMemberModal(${i})">Editar</button>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteMember(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6">Nenhum</td></tr>';
    }

    function clearAllMembers() {
      if (confirm('Apagar TODOS?')) {
        state.members[state.clan] = [];
        saveState();
        renderMembers();
        fillEventNickOptions();
        showMessage('‚úÖ Apagado!', 'success');
      }
    }

    function fillEventNickOptions() {
      const select = document.getElementById('event-nick');
      if (select) {
        select.innerHTML = '<option>-- Selecione --</option>' + (state.members[state.clan] || [])
          .sort((a, b) => a.nick.localeCompare(b.nick, 'pt-BR'))
          .map(m => `<option>${m.nick}</option>`).join('');
      }
    }

    function openEventModal(index = null) {
      document.getElementById('event-index').value = index !== null ? index : '';
      if (index !== null && index !== '') {
        const e = state.events[state.clan][index];
        document.getElementById('event-date').value = toBRFromISO(e.data);
        document.getElementById('event-name').value = e.evento;
        document.getElementById('event-status').value = e.status;
        document.getElementById('event-just').value = e.justificativa || '';
      } else {
        document.getElementById('event-date').value = todayBR();
        document.getElementById('event-name').value = 'Boss do cl√£';
        document.getElementById('event-status').value = 'Presente';
        document.getElementById('event-just').value = '';
      }
      fillEventNickOptions();
      openModal('event-modal');
    }

    function saveEvent() {
      const idx = document.getElementById('event-index').value;
      const nick = document.getElementById('event-nick').value;
      if (!nick) { showMessage('‚ùå Nick obrigat√≥rio', 'error'); return; }
      const record = {
        data: toISOFromBR(document.getElementById('event-date').value),
        evento: document.getElementById('event-name').value,
        nick,
        status: document.getElementById('event-status').value,
        justificativa: document.getElementById('event-just').value
      };
      if (idx !== '') state.events[state.clan][parseInt(idx)] = record;
      else state.events[state.clan].push(record);
      saveState();
      renderEvents();
      closeModal('event-modal');
      showMessage('‚úÖ Salvo!', 'success');
    }

    function deleteEvent(index) {
      if (confirm('Excluir?')) {
        state.events[state.clan].splice(index, 1);
        saveState();
        renderEvents();
        showMessage('‚úÖ Exclu√≠do!', 'success');
      }
    }

    function renderEvents() {
      const body = document.getElementById('events-body');
      let list = [...(state.events[state.clan] || [])];
      const filterEvent = document.getElementById('filterEvent')?.value || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      if (filterEvent) list = list.filter(e => e.evento === filterEvent);
      if (filterStatus) list = list.filter(e => e.status === filterStatus);
      list.sort((a, b) => (a.data || '').localeCompare(b.data || ''));
      body.innerHTML = list.map((e, i) => `
        <tr>
          <td>${toBRFromISO(e.data)}</td><td><strong>${e.nick}</strong></td><td>${e.evento}</td>
          <td><strong style="color: ${e.status === 'Presente' ? '#27ae60' : e.status === 'Faltou' ? '#e74c3c' : '#f39c12'}">${e.status}</strong></td>
          <td>${e.justificativa || '-'}</td>
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openEventModal(${i})">Editar</button>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteEvent(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6">Nenhum</td></tr>';
    }

    function clearAllEvents() {
      if (confirm('Apagar TODOS?')) {
        state.events[state.clan] = [];
        saveState();
        renderEvents();
        showMessage('‚úÖ Apagado!', 'success');
      }
    }

    function openDeliveryModal(index = null) {
      document.getElementById('delivery-index').value = index !== null ? index : '';
      if (index !== null && index !== '') {
        const d = state.deliveries[state.clan][index];
        document.getElementById('delivery-date').value = toBRFromISO(d.data);
        document.getElementById('delivery-nick').value = d.nick;
        document.getElementById('delivery-class').value = d.classe;
        document.getElementById('delivery-desc').value = d.descricao || '';
      } else {
        document.getElementById('delivery-date').value = todayBR();
        document.getElementById('delivery-nick').value = '';
        document.getElementById('delivery-class').value = 'Arqueira';
        document.getElementById('delivery-desc').value = '';
      }
      openModal('delivery-modal');
    }

    function saveDelivery() {
      const idx = document.getElementById('delivery-index').value;
      const nick = document.getElementById('delivery-nick').value.trim();
      const desc = document.getElementById('delivery-desc').value.trim();
      if (!nick || !desc) { showMessage('‚ùå Campos obrigat√≥rios', 'error'); return; }
      const record = {
        data: toISOFromBR(document.getElementById('delivery-date').value),
        nick, classe: document.getElementById('delivery-class').value, descricao: desc
      };
      if (idx !== '') state.deliveries[state.clan][parseInt(idx)] = record;
      else state.deliveries[state.clan].push(record);
      saveState();
      closeModal('delivery-modal');
      renderDeliveries();
      showMessage('‚úÖ Salvo!', 'success');
    }

    function deleteDelivery(index) {
      if (confirm('Excluir?')) {
        state.deliveries[state.clan].splice(index, 1);
        saveState();
        renderDeliveries();
        showMessage('‚úÖ Exclu√≠do!', 'success');
      }
    }

    function renderDeliveries() {
      const body = document.getElementById('deliveries-body');
      let list = [...(state.deliveries[state.clan] || [])];
      const search = (document.getElementById('searchDeliveriesNick')?.value || '').toLowerCase();
      const filterClass = document.getElementById('filterDeliveriesClass')?.value || '';
      if (search) list = list.filter(d => d.nick.toLowerCase().includes(search));
      if (filterClass) list = list.filter(d => d.classe === filterClass);
      list.sort((a, b) => a.nick.localeCompare(b.nick, 'pt-BR'));
      body.innerHTML = list.map((d, i) => `
        <tr>
          <td>${toBRFromISO(d.data)}</td><td>${d.nick}</td><td>${d.classe}</td><td>${d.descricao}</td>
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openDeliveryModal(${i})">Editar</button>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteDelivery(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5">Nenhum</td></tr>';
    }

    function clearAllDeliveries() {
      if (confirm('Apagar TODOS?')) {
        state.deliveries[state.clan] = [];
        saveState();
        renderDeliveries();
        showMessage('‚úÖ Apagado!', 'success');
      }
    }

    function showMonthlyReport() {
      document.getElementById('monthly-report-card').style.display = 'block';
      if (!document.getElementById('reportMonth').value) {
        const now = new Date();
        document.getElementById('reportMonth').value = now.toISOString().slice(0, 7);
      }
      renderMonthlyReport();
    }

    function renderMonthlyReport() {
      const monthInput = document.getElementById('reportMonth').value;
      const body = document.getElementById('monthly-report-body');
      if (!monthInput) return;
      const [year, month] = monthInput.split('-');
      const list = (state.deliveries[state.clan] || []).filter(d => d.data && d.data.startsWith(year + '-' + month));
      const byNick = {};
      list.forEach(d => {
        if (!byNick[d.nick]) byNick[d.nick] = [];
        byNick[d.nick].push(d.descricao || '(sem descri√ß√£o)');
      });
      const nicks = Object.keys(byNick).sort((a, b) => a.localeCompare(b, 'pt-BR'));
      body.innerHTML = nicks.map(nick => `
        <tr><td>${nick}</td><td>${byNick[nick].join(' ‚Ä¢ ')}</td></tr>
      `).join('') || '<tr><td colspan="2">Nenhum</td></tr>';
    }

    function renderRepo() {
      const tbody = document.getElementById('repoTableBody');
      let list = [...(state.repoItems[state.clan] || [])];
      const search = (document.getElementById('searchRepoItem')?.value || '').toLowerCase();
      if (search) list = list.filter(r => (r.item || '').toLowerCase().includes(search));
      tbody.innerHTML = list.map((r, i) => `
        <tr>
          <td>${r.item}</td><td>${r.tipo || ''}</td><td>${r.boss || ''}</td><td>${r.qtd || ''}</td>
          <td><button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteRepoItem(${i})">Excluir</button></td>
        </tr>
      `).join('') || '<tr><td colspan="5">Nenhum</td></tr>';
    }

    function addRepoItem() {
      const nome = document.getElementById('repoItem').value.trim();
      if (!nome) { showMessage('‚ùå Nome obrigat√≥rio', 'error'); return; }
      const list = state.repoItems[state.clan] || (state.repoItems[state.clan] = []);
      const idx = list.findIndex(r => r.item.toLowerCase() === nome.toLowerCase());
      const qtd = parseInt(document.getElementById('repoQuantity').value) || 0;
      if (idx >= 0) {
        list[idx] = { item: nome, tipo: document.getElementById('repoType').value.trim(), boss: document.getElementById('repoBoss').value.trim(), qtd };
      } else {
        list.push({ item: nome, tipo: document.getElementById('repoType').value.trim(), boss: document.getElementById('repoBoss').value.trim(), qtd });
      }
      document.getElementById('repoItem').value = '';
      document.getElementById('repoType').value = '';
      document.getElementById('repoBoss').value = '';
      document.getElementById('repoQuantity').value = '';
      saveState();
      renderRepo();
      showMessage('‚úÖ Salvo!', 'success');
    }

    function clearRepo() {
      if (confirm('Limpar?')) {
        state.repoItems[state.clan] = [];
        saveState();
        renderRepo();
        showMessage('‚úÖ Limpo!', 'success');
      }
    }

    function deleteRepoItem(index) {
      if (confirm('Remover?')) {
        state.repoItems[state.clan].splice(index, 1);
        saveState();
        renderRepo();
        showMessage('‚úÖ Removido!', 'success');
      }
    }

    function renderAll() {
      renderMembers();
      renderEvents();
      renderDeliveries();
      renderRepo();
    }

    window.addEventListener('load', loadState);
  </script>
</body>
</html>
